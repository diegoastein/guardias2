<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial del M√©dico</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    window.firebaseModules = { initializeApp, getFirestore, collection, onSnapshot, getAuth, signInAnonymously };
  </script>
</head>

<body class="bg-gray-100">
  <div id="root"></div>

<script type="text/babel">

const { useState, useEffect } = React;
const { initializeApp, getFirestore, collection, onSnapshot, getAuth, signInAnonymously } = window.firebaseModules;

/* üîê Firebase config ‚Äî MISMAS credenciales */
const firebaseConfig = {
  apiKey: "AIzaSyB6AKWdDANzAjr5OHeskhT_KF_Gyco2fVY",
  authDomain: "guardias-5c5d9.firebaseapp.com",
  projectId: "guardias-5c5d9"
};

/* ===================== HELPERS ===================== */
const formatDate = (iso) => {
  if (!iso) return '';
  const [y, m, d] = iso.split('-');
  return `${d}/${m}/${y}`;
};

/* ===================== HISTORIAL LICENCIAS ===================== */
function HistorialLicencias({ medicoId, licencias }) {
  const [anio, setAnio] = useState('');

  if (!medicoId) return <p className="italic text-gray-500">Seleccione un m√©dico.</p>;

  const filtradas = licencias
    .filter(l =>
      String(l.medicoId) === String(medicoId) &&
      (!anio || l.desde.startsWith(anio))
    )
    .sort((a, b) => a.desde.localeCompare(b.desde));

  const anios = [...new Set(licencias.map(l => l.desde.slice(0,4)))].sort().reverse();

  return (
    <div className="space-y-4">
      <select
        className="border p-2 rounded"
        value={anio}
        onChange={e => setAnio(e.target.value)}
      >
        <option value="">Todos los a√±os</option>
        {anios.map(a => <option key={a} value={a}>{a}</option>)}
      </select>

      <table className="w-full border text-sm">
        <thead className="bg-gray-200">
          <tr>
            <th className="border p-2">Motivo</th>
            <th className="border p-2">Desde</th>
            <th className="border p-2">Hasta</th>
            <th className="border p-2">Detalle</th>
          </tr>
        </thead>
        <tbody>
          {filtradas.map((l, i) => (
            <tr key={i}>
              <td className="border p-2">{l.motivo}</td>
              <td className="border p-2">{formatDate(l.desde)}</td>
              <td className="border p-2">{formatDate(l.hasta)}</td>
              <td className="border p-2">{l.detalleCobertura || ''}</td>
            </tr>
          ))}
        </tbody>
      </table>

      {filtradas.length === 0 && <p className="italic text-gray-500">Sin licencias.</p>}
    </div>
  );
}

/* ===================== HISTORIAL GUARDIAS ===================== */
function HistorialGuardias({ medicoId, guardias, plantilla, medicos, licencias }) {
  const [mes, setMes] = useState('');

  if (!medicoId) return <p className="italic text-gray-500">Seleccione un m√©dico.</p>;

  const estaDeLicencia = (id, fecha) =>
    licencias.some(l => String(l.medicoId) === String(id) && fecha >= l.desde && fecha <= l.hasta);

  const resultados = [];
  const resumen = { propia: 0, extra: 0, cobertura: 0, arreglo: 0 };

  if (mes) {
    const [y, m] = mes.split('-').map(Number);
    const dias = new Date(y, m, 0).getDate();

    for (let d = 1; d <= dias; d++) {
      const fecha = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const g = guardias[fecha];
      if (!g) continue;

      const p = plantilla[new Date(y, m-1, d).getDay()];
      const slots = [
        ['dia1','D√≠a 1'],['dia2','D√≠a 2'],['noche1','Noche 1'],['noche2','Noche 2']
      ];

      slots.forEach(([k, label]) => {
        const s = g[k];
        if (!s || s.estado !== 'CUBIERTA' || String(s.medicoId) !== String(medicoId)) return;

        let tipo = 'Extra', detalle = 'Extra';

        if (s.tipoPago === 'PERSONAL') {
          tipo = 'Arreglo'; detalle = 'Personal'; resumen.arreglo++;
        } else if (p?.[k]?.medicoId === medicoId) {
          tipo = 'Propia'; detalle = 'Titular'; resumen.propia++;
        } else if (!p?.[k]?.medicoId) {
          tipo = 'Cobertura vacante'; detalle = 'Vacante'; resumen.cobertura++;
        } else if (estaDeLicencia(p[k].medicoId, fecha)) {
          tipo = 'Cobertura licencia';
          const t = medicos.find(m => String(m.id) === String(p[k].medicoId));
          detalle = t ? `Cubre a ${t.nombre}` : 'Licencia';
          resumen.cobertura++;
        } else {
          resumen.extra++;
        }

        resultados.push({ fecha, turno: label, tipo, detalle });
      });
    }
  }

  return (
    <div className="space-y-4">
      <input type="month" value={mes} onChange={e => setMes(e.target.value)}
        className="border p-2 rounded" />

      {mes && (
        <div className="flex gap-4 text-sm font-bold">
          <span>Propias: {resumen.propia}</span>
          <span>Extras: {resumen.extra}</span>
          <span>Coberturas: {resumen.cobertura}</span>
          <span>Arreglos: {resumen.arreglo}</span>
        </div>
      )}

      <table className="w-full border text-sm">
        <thead className="bg-gray-200">
          <tr>
            <th className="border p-2">Fecha</th>
            <th className="border p-2">Turno</th>
            <th className="border p-2">Tipo</th>
            <th className="border p-2">Detalle</th>
          </tr>
        </thead>
        <tbody>
          {resultados.map((r,i) => (
            <tr key={i}>
              <td className="border p-2">{formatDate(r.fecha)}</td>
              <td className="border p-2">{r.turno}</td>
              <td className="border p-2 font-bold">{r.tipo}</td>
              <td className="border p-2">{r.detalle}</td>
            </tr>
          ))}
        </tbody>
      </table>

      {mes && resultados.length === 0 && <p className="italic">Sin guardias.</p>}
    </div>
  );
}

/* ===================== APP ===================== */
function App() {
  const [medicos, setMedicos] = useState([]);
  const [licencias, setLicencias] = useState([]);
  const [guardias, setGuardias] = useState({});
  const [plantilla, setPlantilla] = useState({});
  const [medicoId, setMedicoId] = useState('');
  const [tab, setTab] = useState('licencias');

  useEffect(() => {
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    signInAnonymously(auth);

    onSnapshot(collection(db,'medicos'), s =>
      setMedicos(s.docs.map(d => ({ id: d.id, ...d.data() })))
    );
    onSnapshot(collection(db,'licencias'), s =>
      setLicencias(s.docs.map(d => d.data()))
    );
    onSnapshot(collection(db,'guardias'), s => {
      const o={}; s.docs.forEach(d => o[d.id]=d.data()); setGuardias(o);
    });
    onSnapshot(collection(db,'plantilla'), s => {
      const o={}; s.docs.forEach(d => o[d.id]=d.data()); setPlantilla(o);
    });
  }, []);

  return (
    <div className="max-w-4xl mx-auto p-4 space-y-4">
      <h1 className="text-2xl font-bold">Historial del M√©dico</h1>

      <select className="border p-2 rounded w-full"
        value={medicoId} onChange={e=>setMedicoId(e.target.value)}>
        <option value="">Seleccione un m√©dico</option>
        {medicos.map(m => <option key={m.id} value={m.id}>{m.nombre}</option>)}
      </select>

      <div className="flex gap-2">
        <button onClick={()=>setTab('licencias')} className={tab==='licencias'?'font-bold':''}>Licencias</button>
        <button onClick={()=>setTab('guardias')} className={tab==='guardias'?'font-bold':''}>Guardias</button>
      </div>

      {tab === 'licencias' && <HistorialLicencias medicoId={medicoId} licencias={licencias} />}
      {tab === 'guardias' && <HistorialGuardias medicoId={medicoId} guardias={guardias} plantilla={plantilla} medicos={medicos} licencias={licencias} />}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
