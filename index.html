<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Historial de Licencias</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- React -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

    window.firebaseInit = async () => {
      const firebaseConfig = {
        apiKey: "AIzaSyB6AKWdDANzAjr5OHeskhT_KF_Gyco2fVY",
        authDomain: "guardias-5c5d9.firebaseapp.com",
        projectId: "guardias-5c5d9",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      await signInAnonymously(auth);

      return { db };
    };
  </script>
</head>

<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function App() {
      const [db, setDb] = useState(null);
      const [medicos, setMedicos] = useState([]);
      const [licencias, setLicencias] = useState([]);

      const [medicoId, setMedicoId] = useState("");
      const [anio, setAnio] = useState("");

      useEffect(() => {
        window.firebaseInit().then(({ db }) => {
          setDb(db);

          onSnapshot(collection(db, "medicos"), snap => {
            setMedicos(snap.docs.map(d => ({ id: d.id, ...d.data() })));
          });

          onSnapshot(collection(db, "licencias"), snap => {
            setLicencias(snap.docs.map(d => ({ id: d.id, ...d.data() })));
          });
        });
      }, []);

      const medicosOrdenados = [...medicos].sort((a,b) =>
        a.nombre.localeCompare(b.nombre)
      );

      const aniosDisponibles = Array.from(
        new Set(licencias.map(l => l.desde?.slice(0,4)))
      ).filter(Boolean).sort((a,b) => b.localeCompare(a));

      const formatDate = iso => {
        if (!iso) return "";
        const [y,m,d] = iso.split("-");
        return `${d}/${m}/${y}`;
      };

      const historial = licencias
        .filter(l =>
          medicoId &&
          String(l.medicoId) === String(medicoId) &&
          (!anio || l.desde?.startsWith(anio))
        )
        .sort((a,b) => a.desde.localeCompare(b.desde));

      const copiarTabla = () => {
        if (!historial.length) return;

        let texto = "Motivo\tDesde\tHasta\tDetalle\n";
        historial.forEach(l => {
          texto += `${l.motivo}\t${formatDate(l.desde)}\t${formatDate(l.hasta)}\t${l.detalleCobertura || ""}\n`;
        });

        navigator.clipboard.writeText(texto)
          .then(() => alert("Historial copiado"));
      };

      return (
        <div className="max-w-4xl mx-auto p-4">
          <h1 className="text-2xl font-bold mb-4">
            Historial de Licencias
          </h1>

          {/* SELECT MÉDICO */}
          <select
            className="w-full p-2 border rounded mb-4"
            value={medicoId}
            onChange={e => setMedicoId(e.target.value)}
          >
            <option value="">Seleccione un médico</option>
            {medicosOrdenados.map(m =>
              <option key={m.id} value={m.id}>{m.nombre}</option>
            )}
          </select>

          {/* SELECT AÑO */}
          <select
            className="w-full p-2 border rounded mb-4"
            value={anio}
            onChange={e => setAnio(e.target.value)}
          >
            <option value="">Todos los años</option>
            {aniosDisponibles.map(a =>
              <option key={a} value={a}>{a}</option>
            )}
          </select>

          {historial.length > 0 && (
            <button
              onClick={copiarTabla}
              className="mb-3 px-3 py-1 bg-blue-600 text-white rounded text-sm"
            >
              Copiar historial
            </button>
          )}

          <table className="w-full bg-white border text-sm">
            <thead className="bg-gray-200">
              <tr>
                <th className="border p-2">Motivo</th>
                <th className="border p-2">Desde</th>
                <th className="border p-2">Hasta</th>
                <th className="border p-2">Detalle</th>
              </tr>
            </thead>
            <tbody>
              {historial.map(l =>
                <tr key={l.id}>
                  <td className="border p-2">{l.motivo}</td>
                  <td className="border p-2">{formatDate(l.desde)}</td>
                  <td className="border p-2">{formatDate(l.hasta)}</td>
                  <td className="border p-2">{l.detalleCobertura || ""}</td>
                </tr>
              )}
              {medicoId && historial.length === 0 && (
                <tr>
                  <td colSpan="4" className="p-4 text-center text-gray-500 italic">
                    Sin licencias registradas
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
